<script context="module">
  import { ResourceSchedule } from "@upswyng/common";

  export async function preload({ params, query }, { user }) {
    if(!user) {
      this.error(401, "You don't have permission to view this page");
      return;
    } 

    let draftResource = null;
    if (!user.isAdmin) {
      // If user is not an admin, make sure the draft they're trying to view is
      // one of their own
      const draftsForUserResponse = await this.fetch("/api/resources/drafts/mine", {
        credentials: "same-origin",
      });
      if (draftsForUserResponse.status !== 200) {
        this.error(draftsForUserResponse.status, draftsForUserResponse.message);
        return;
      }
      const {draftResources} = await draftsForUserResponse.json();
      draftResource = draftResources.find(draft => draft._id === params._id);
      if(!draftResource) {
        this.error(401, "You don't have permission to view this page");
        return;
      } 
    } else {
      const draftResourceResponse = await this.fetch(
        `/api/resource/draft/${params._id}`
      );
      if (draftResourceResponse.status !== 200) {
        this.error(draftResourceResponse.status, draftResourceResponse.message);
        return;
      }
      draftResource = (await draftResourceResponse.json()).draftResource;
    }

    // See if we have an existing resource corresponding to this draft
    const existingResourceResponse = await this.fetch(
      `/api/resource/${draftResource.resourceId}`
    );
    const existingResource = existingResourceResponse.status === 200
      ? (await existingResourceResponse.json()).resource
      : null;

    return {
      draftResource: withSchedule(draftResource),
      existingResource: withSchedule(existingResource),
      isAdmin: user.isAdmin,
    };
  }

  function withSchedule(resource) {
    if(!resource) return null;
    return {
      ...resource,
      schedule: ResourceSchedule.parse(
        resource.schedule
      ),
    }
  }
</script>

<script>
  import { addFlashMessage } from "./../../../../utility/flashMessage.ts";
  import { goto, stores } from "@sapper/app";
  import ResourceDiff from "./../../../../components/ResourceDiff.svelte";
  import ResourceDisplay from "./../../../../components/ResourceDisplay.svelte";

  const { session } = stores();

  export let draftResource;
  export let existingResource; // resource in the directory which this draft would update; null for new resources
  export let isAdmin = false;

  let isDeleting = false; // Whether we've issued a call to the server to delete the draft resource
  let deleteError = null; // error? Poupulated with the error from a detete attempt, if there has been one

  let isApproving = false; // Whether we've issued a call to the server to approve the draft resource
  let approveError = null; // error? Poupulated with the error from an approve attempt, if there has been one

  function deleteDraft(_id) {
    isDeleting = true;

    fetch(`/api/resource/draft/delete/${_id}`, { method: "POST" })
      .then(_res => {
        if (_res.status >= 400) {
          throw new Error(_res);
        }
        addFlashMessage(
          session,
          "success",
          draftResource.name
            ? `The draft of ${draftResource.name} was deleted`
            : "The draft resource was deleted"
        );
        goto("/provider/resource");
      })
      .catch(e => (deleteError = e))
      .finally(() => (isDeleting = false));
  }

  async function approveUpdate(_id) {
    isApproving = true;

    fetch(`/api/resource/draft/approve/${_id}`, { method: "POST" })
      .then(async res => {
        if (res.status >= 400) {
          const { message } = await res.json();
          if (message) {
            throw new Error(message);
          }
          throw new Error(res);
        }
        addFlashMessage(
          session,
          "success",
          `The draft of ${draftResource.name} was approved`
        );
        goto("/provider/resource");
      })
      .catch(e => (approveError = e))
      .finally(() => (isApproving = false));
  }
</script>

<svelte:head>
  <title>UpSwyng: {draftResource.name} [draft]</title>
</svelte:head>

<section class="section">
  <div class="container">
    <h1 class="title">
      {#if existingResource}
        Update Service Provider: {existingResource.name}
      {:else}Create New Service Provider{/if}
      {#if isAdmin}
        <span class="tag is-dark">Admin</span>
      {/if}
    </h1>
    {#if existingResource}
      <p class="subtitle">
        Service Provider ID:
        <a href={`/provider/resource/${existingResource.resourceId}`}>
          {existingResource.resourceId}
        </a>
      </p>
    {/if}
    {#if draftResource.createdBy}
      <div class="columns">
        <div class="column is-one-third-desktop is-half-tablet">
          <div class="card">
            <div class="card-header">
              <h2 class="card-header-title">Draft Created By:</h2>
            </div>
            <div class="card-content">
              <p class="content">
                {#if draftResource.createdBy.name}
                  <span class="icon">
                    <i class="fas fa-user" aria-label="name" />
                  </span>
                  {draftResource.createdBy.name}
                  <br />
                {/if}
                <span class="icon">
                  <i class="fas fa-envelope" aria-label="email" />
                </span>
                <a href={`mailto:${draftResource.createdBy.email}`}>
                  {draftResource.createdBy.email}
                </a>
              </p>
            </div>
          </div>
        </div>
      </div>
    {/if}
    {#if existingResource}
      <ResourceDiff
        leftResource={existingResource}
        rightResource={draftResource} />
    {:else}
      <ResourceDisplay resource={draftResource} />
    {/if}

    {#if isAdmin}
      <div class="buttons">
        <button
          class="button is-danger is-outlined"
          class:is-loading={isDeleting}
          type="button"
          preventDefault
          disabled={isApproving}
          on:click={() => deleteDraft(draftResource._id)}>
          <span class="icon is-small">
            <i class="fas fa-times" />
          </span>
          <span>Delete Draft</span>
        </button>
        <button
          class="button is-success"
          class:is-loading={isApproving}
          type="button"
          preventDefault
          disabled={isDeleting}
          on:click={() => approveUpdate(draftResource._id)}>
          <span class="icon is-small">
            <i class="fas fa-check" />
          </span>
          <span>Approve Update</span>
        </button>
      </div>
    {/if}
    <div>
      {#if approveError}
        <p class="notification is-danger">
          There was an error approving the service provider: {approveError.message}
        </p>
      {/if}
      {#if deleteError}
        <p class="notification is-danger">
          There was an error deleting the service provider: {deleteError.message}
        </p>
      {/if}
    </div>
  </div>
</section>
